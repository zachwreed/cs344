#!/bin/bash
#------------------------------
#Author: Zach Reed
#Description:  Matrix Script
#Date: 9/27/2019
#------------------------------


#-----------------------
# Temporary Files
#-----------------------
m1="m1_$$"
m2="m2_$$"
m3="m3_$$"
m4="m4_$$"
m5="m5_$$"

trap "rm -f $m1 $m2 $m3 $m4; echo 'SIGINT received: Deleting temp files..'; exit 1" INT
#-----------------------
# Error Function Handler
#-----------------------
err() {
	echo "$@" >&2
}

#-----------------------
# Get Columns  Function
#-----------------------
cols() {
	read line<$1
	local col_n=0
	for i in $line
	do
		((++col_n))
	done
	echo "$col_n"
}

#-----------------------
# Get Rows Function
#-----------------------
rows() {
	local row_n=0
	while read -r line
	do
		((++row_n))
	done < "$1"
	echo "$row_n"	
}

#-----------------------
# dimension Function
#-----------------------

dims() {
	#cols $1 $m1
	local col_n=$(cols $m1)
	local row_n=$(rows $m1)
	echo "$row_n $col_n"
}

#-----------------------
# transpose Function
#-----------------------
transpose() {
	local col_n=$(cols $m1)
	local row_n=$(rows $m1)	

	for ((i=1 ; i<=$col_n ; i++))
	do 
		line=$(cat $m1 | cut -f $i -d$'\t' | tr "\n" "\t")
		line=${line%?}
		echo "$line"
	done	
}

#-----------------------
# mean Function
#-----------------------
mean() {
        local col_n=$(cols $m1)
        local row_n=$(rows $m1)
	local sum=0
	local mean=0

	for ((i=1 ; i<=$col_n ; i++))
	do
		line=$(cat $m1 | cut -f $i -d$'\t' | tr "\n" "\t")
		for j in $line
		do
			sum=$(($j + $sum))
		done
		mean=$((($sum+($row_n/2)*( ($sum>0)*2-1))/$row_n))
		if [[ $i == 1 ]]               
                then
                	printf "%d" $mean

                else
                	printf "\t%d" $mean
                fi

		mean=0
		sum=0
	done
	printf "\n"
}


#-----------------------
# Add Function
#-----------------------
add() {
	local col_m1=$(cols $m1)
	local row_m1=$(rows $m1)
	local col_m2=$(cols $m2)
	local row_m2=$(rows $m2)

	if [[ $col_m1 != $col_m2 || $row_m1 != $row_m2 ]]
	then
		err "Invalid matrices sizes"
		exit 2
	fi

	for ((i=1 ; i<=$col_m1 ; i++))
	do
		cutM1=$(cat $m1 | cut -f $i -d$'\t' | tr "\n" "\t")
		cutM2=$(cat $m2 | cut -f $i -d$'\t' | tr "\n" "\t")
		echo "$cutM1" > $m3
		echo "$cutM2" >> $m3
		#cat $m3
		
		for((j=1 ; j<=$row_m1 ; j++))
		do 
			cutM3=$(cat $m3 | cut -f $j -d$'\t' | tr "\n" "\t")
			echo "$cutM3" > $m4
			read line<$m4

			local add=0
			for k in $line
			do	
				add=$(($add + $k))	
			done
			echo -e -n "$add\t" >> $m5
		done
		echo "" >> $m5
	done

	for ((i=1 ; i<=$row_m1 ; i++))
        do
                line=$(cat $m5 | cut -f $i -d$'\t' | tr "\n" "\t")
                line=${line%?}
                echo "$line"
        done
	rm $m3 $m4 $m5
}


#-----------------------
# Main Function
#-----------------------

main() {
	#echo $1 ${@:2}

	if [[ $(type -t $1) == "function" ]]
	then
		if [[ $1 == "dims" || $1 == "mean" || $1 == "transpose" ]]
		then
			if [[ $# == "1" ]]
			then
    				cat > "$m1"
				$1
				rm $m1
				exit 0

			elif [[ $# == "2" && -r "$2" ]]
			then
    				m1=$2
				$1
				exit 0

			else 
				err "Invalid arguments: " $#
				exit 2
			fi

		# "mul"or "add" ----------------------------------------
		else
			if [[ "$#" == "3" ]]
			then
				m1=$2
				m2=$3
				$1
				exit 0
		
			else 
				err "Invalid matrices" $#
				exit 2
			fi
		fi
	else
		err "Invalid function call: $1"
		exit 2
	fi
}

main $1 "${@:2}"

